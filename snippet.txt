            <div
              v-for="item in messageTimeline"
              :key="item.id"
              class="timeline-entry"
            >
              <div
                v-if="item.type === 'date'"
                class="day-divider"
              >
                <span class="day-divider-label">{{ item.label }}</span>
              </div>
              <div
                v-if="item.type !== 'date'"
                class="msg-row"
                :class="{ sent: item.message.sentByMe }"
              >
                <template v-if="!item.message.sentByMe && partnerAvatar">
                  <img :src="partnerAvatar" class="avatar-xs me-2" alt="avatar" />
                </template>
                <div :class="['chat-bubble', item.message.sentByMe ? 'sent' : 'received']">
                  <div class="bubble-header">
                    <span class="name">{{ item.message.sentByMe ? pseudo : partnerName }}</span>
                    <span class="time">{{ formatDate(item.message.ts_msg) }}</span>
                  </div>
                  <div class="bubble-body">
                    <template v-if="editingId === item.message.id_msg">
                      <input v-model="editContent" class="form-control form-control-sm mb-1" />
                      <div class="text-end">
                        <button class="btn btn-sm btn-success me-1" @click="confirmEdit">OK</button>
                        <button class="btn btn-sm btn-secondary" @click="cancelEdit">Annuler</button>
                      </div>
                    </template>
                    <template v-else>
                      {{ item.message.contenu_chiffre || (item.message.files?.length ? `${item.message.files.length} pièce(s) jointe(s)` : '') }}
                    </template>
                  </div>

                  <div v-if="item.message.files && item.message.files.length" class="bubble-attachments mt-2">
                    <div
                      v-for="file in item.message.files"
                      :key="file.id_file"
                      class="attachment-item"
                      :class="{ preview: isInlineImage(file) }"
                    >
                      <template v-if="isInlineImage(file)">
                        <button
                          type="button"
                          class="attachment-thumb"
                          :aria-label="`Télécharger ${file.filename}`"
                          @click="downloadAttachment(file)"
                        >
                          <img
                            v-if="attachmentPreviews[file.id_file]"
                            :src="attachmentPreviews[file.id_file]"
                            :alt="file.filename"
                            @load="onAttachmentImageLoad"
                          />
                          <span v-else class="spinner-border spinner-border-sm text-primary"></span>
                        </button>
                        <div class="attachment-meta">
                          <div class="attachment-name" v-html="highlightFilename(file.filename)"></div>
                          <small class="text-muted">{{ formatSize(file.taille) }}</small>
                        </div>
                      </template>
                      <template v-else>
                        <i class="bi bi-paperclip me-2"></i>
                        <button class="btn btn-link p-0 attachment-link" type="button" @click="downloadAttachment(file)">
                          <span v-html="highlightFilename(file.filename)"></span>
                        </button>
                        <small class="text-muted ms-2">{{ formatSize(file.taille) }}</small>
                      </template>
                    </div>
                  </div>

                  <div class="reaction-strip mt-2">
                    <button
                      v-for="reaction in reactionSummary(item.message)"
                      :key="reaction.emoji"
                      class="reaction-chip"
                      :class="{ mine: reaction.mine }"
                      type="button"
                      @click="toggleReaction(item.message.id_msg, reaction.emoji)"
                    >
                      <span class="emoji">{{ reaction.emoji }}</span>
                      <span class="count">{{ reaction.count }}</span>
                    </button>
                    <div class="reaction-picker" v-if="reactionPickerFor === item.message.id_msg">
                      <emoji-picker
                        class="reaction-emoji-picker"
                        skin-tone-emoji="??"
                        @emoji-click="event => onReactionEmoji(item.message.id_msg, event)"
                      ></emoji-picker>
                    </div>
                    <button
                      class="btn btn-light btn-sm add-reaction"
                      type="button"
                      @click="toggleReactionPicker(item.message.id_msg)"
                    >
                      <i class="bi bi-emoji-smile"></i>
                    </button>
                  </div>

                  <div v-if="item.message.sentByMe" class="bubble-actions text-end">
                    <button class="btn btn-action me-1" @click="startEdit(item.message)" title="Modifier">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-action danger" @click="deleteMessage(item.message.id_msg)" title="Supprimer">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
